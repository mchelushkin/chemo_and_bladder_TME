---
title: Cisplatin-treated sub-cohort. Correlations between signatures, distances, and PD-L1. Comparing independent Rs.
author: "Maksim Chelushkin"
date: " `r format(Sys.time(), '%A %B %d, %Y (%H:%M:%S)')` "
output:
  html_document: 
    toc: yes
    toc_float: yes
    code_folding: hide
    mode: selfcontained
    fig_caption: yes
fontsize: 9pt
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, dpi=100, include = TRUE)
knitr::opts_knit$set(root.dir = "~/Michiel_projects/chemo_paper/code/")
library(reticulate)
library(EnhancedVolcano)
library(rstatix)
use_condaenv("base", required = TRUE)
```

```{python}
import pandas as pd
import matplotlib.pyplot as plt
import matplotlib
import seaborn as sns
import numpy as np
from scipy.stats import pearsonr, spearmanr, kendalltau
import os
from scipy.stats import wilcoxon, ttest_ind, ttest_rel, mannwhitneyu, shapiro
from statsmodels.stats.multitest import multipletests
import statsmodels.formula.api as smf
import statsmodels.api as sm
from glob import glob
from statannotations.Annotator import Annotator
matplotlib.rcParams['figure.dpi'] = 150
import gseapy as gp
from gseapy.parser import gsea_gmt_parser
```

```{python}
figsize1 = (8, 5)
figsize2 = (6, 4)
figsize3 = (10, 10)
def simple_scatter(x, y, ax, parameter_name, line=False):
    nas = np.logical_or(x.isna(), y.isna())
    x1 = x[~nas]
    y1 = y[~nas]
    ax.scatter(x1, y1)
    ax.set_title(parameter_name.replace('HALLMARK_','')
                 + '\nPearson R = {:.2f}, p = {:.2g}'.format(*pearsonr(x1,y1)) + '\nSpearman R = {:.2f}, p = {:.2g}'.format(*spearmanr(x1,y1)))
    loc_min = min(x1.min(), y1.min())
    loc_max = max(x1.max(), y1.max())
    if line:
      ax.plot((loc_min, loc_max), (loc_min, loc_max))
```

```{python}
from rpy2.robjects import r

def kendall_diff(df_tur, df_cys, param1, param2):
  nas_tur = np.logical_or(df_tur.loc[:, param1].isna(), df_tur.loc[:, param2].isna())
  nas_cys = np.logical_or(df_cys.loc[:, param1].isna(), df_cys.loc[:, param2].isna())
  n1 = len(df_tur.loc[:, param1][~nas_tur])
  n2 = len(df_cys.loc[:, param1][~nas_cys])
  r12 = np.sin(np.pi*kendalltau(df_tur.loc[~nas_tur, param1], df_tur.loc[~nas_tur, param2])[0]/2)
  r34 = np.sin(np.pi*kendalltau(df_cys.loc[~nas_cys, param1], df_cys.loc[~nas_cys, param2])[0]/2)
  res_indep = r('''
    library(psych)
    r.test(n = {}, r12 = {}, r34 = {}, n2 = {})
  '''.format(n1, r12, r34, n2))
  return res_indep[3][0], r12, r34

def spearman_diff(df_tur, df_cys, param1, param2):
  nas_tur = np.logical_or(df_tur.loc[:, param1].isna(), df_tur.loc[:, param2].isna())
  nas_cys = np.logical_or(df_cys.loc[:, param1].isna(), df_cys.loc[:, param2].isna())
  n1 = len(df_tur.loc[:, param1][~nas_tur])
  n2 = len(df_cys.loc[:, param1][~nas_cys])
  r12 = spearmanr(df_tur.loc[~nas_tur, param1], df_tur.loc[~nas_tur, param2])[0]
  r34 = spearmanr(df_cys.loc[~nas_cys, param1], df_cys.loc[~nas_cys, param2])[0]
  res_indep = r('''
    library(psych)
    r.test(n = {}, r12 = {}, r34 = {}, n2 = {})
  '''.format(n1, r12, r34, n2))
  return res_indep[3][0], r12, r34

def pearson_diff(df_tur, df_cys, param1, param2):
  nas_tur = np.logical_or(df_tur.loc[:, param1].isna(), df_tur.loc[:, param2].isna())
  nas_cys = np.logical_or(df_cys.loc[:, param1].isna(), df_cys.loc[:, param2].isna())
  n1 = len(df_tur.loc[:, param1][~nas_tur])
  n2 = len(df_cys.loc[:, param1][~nas_cys])
  r12 = pearsonr(df_tur.loc[~nas_tur, param1], df_tur.loc[~nas_tur, param2])[0]
  r34 = pearsonr(df_cys.loc[~nas_cys, param1], df_cys.loc[~nas_cys, param2])[0]
  res_indep = r('''
    library(psych)
    r.test(n = {}, r12 = {}, r34 = {}, n2 = {})
  '''.format(n1, r12, r34, n2))
  return res_indep[3][0], r12, r34
```

```{python}
def dyn_comp_lin(u, ax, lin_dens3, title, xlabel, loc_leg = 'lower right', hue = 'ic_level', test='t-test_ind', test_name='t-test', log_scale = False, log_data = None):
  sns.boxplot(y=u, hue = hue, x = 'sample_type', data = lin_dens3, ax=ax, hue_order = ['low', 'high'], order = ['TUR', 'Cystectomy'],
                    palette = box_palette, showfliers=False)
  sns.stripplot(y=u, hue = hue, x = 'sample_type', data = lin_dens3, ax=ax, hue_order = ['low', 'high'], order = ['TUR', 'Cystectomy'],
                    color='black', dodge=True)
  ax.set_xlabel('')
  ax.set_ylabel(xlabel)
  ax.set_title(title)
  
  if log_scale:
    ax.set_yscale("log")
    annotator = Annotator(ax, pairs = [(('TUR', 'low'), ('TUR', 'high')), (('Cystectomy', 'low'), ('Cystectomy', 'high'))], data = log_data, x='sample_type', hue = hue, y=u, hue_order = ['low', 'high'], order = ['TUR', 'Cystectomy'])
  else:
    annotator = Annotator(ax, pairs = [(('TUR', 'low'), ('TUR', 'high')), (('Cystectomy', 'low'), ('Cystectomy', 'high'))], data = lin_dens3, x='sample_type', hue = hue, y=u, hue_order = ['low', 'high'], order = ['TUR', 'Cystectomy'])
  annotator.configure(test=test, text_format = 'simple', comparisons_correction='BH')
  _, test_results = annotator.apply_test()._get_output()
  #pv = test_results[0].data.pvalue
  annotator.set_custom_annotations(['{} p={:.2g}'.format(test_name, test_results[0].data.pvalue), '{} p={:.2g}'.format(test_name, test_results[1].data.pvalue)])
  annotator.annotate()
  handles, labels = ax.get_legend_handles_labels()
  ax.legend(handles[0:2], labels[0:2], loc=loc_leg)
```

```{python}
#box_palette = {'high': 'cornflowerblue', 'low': 'lightcoral'}
def box_comp(u, ax, lin_dens3, log_dens3, title, xlabel, x='sig_level', test='t-test_ind', test_name='t-test'):
  sns.boxplot(y=u, x=x, data = lin_dens3, ax=ax, order = ['low', 'high'],
                    palette = box_palette, showfliers=False, medianprops=dict(color="red", alpha=0.7, linewidth=3))
  sns.stripplot(y=u, x=x, data = lin_dens3, ax=ax, order = ['low', 'high'],
                    color='black')
      
  ax.set_yscale("log")    
  ax.set_xlabel('')
  ax.set_ylabel(xlabel)
  ax.set_title(title)
  
  annotator = Annotator(ax, pairs = [('low', 'high')], data = log_dens3, x=x, y=u, order=['low', 'high'])
  annotator.configure(test=test, text_format = 'simple', comparisons_correction='BH')
  _, test_results = annotator.apply_test()._get_output()
  pv = test_results[0].data.pvalue
  annotator.set_custom_annotations(['{} p={:.2g}'.format(test_name, pv)])
  annotator.annotate()
  
  
def box_comp_ic(u, ax, lin_dens3, title, xlabel, x='sig_level', test='t-test_ind', test_name='t-test', swarm=True):
  sns.boxplot(y=u, x=x, data = lin_dens3, ax=ax, order = ['low', 'high'],
                    color = 'lightskyblue', showfliers=False)
  if swarm:
    sns.swarmplot(y=u, x=x, data = lin_dens3, ax=ax, order = ['low', 'high'],
                    color='black')
  else:
    sns.stripplot(y=u, x=x, data = lin_dens3, ax=ax, order = ['low', 'high'],
                    color='black')
  ax.set_xlabel('')
  ax.set_ylabel(xlabel)
  ax.set_title(title)
  
  annotator = Annotator(ax, pairs = [('low', 'high')], data = lin_dens3, x=x, y=u, order=['low', 'high'])
  annotator.configure(test=test, text_format = 'simple', comparisons_correction='BH')
  _, test_results = annotator.apply_test()._get_output()
  pv = test_results[0].data.pvalue
  annotator.set_custom_annotations(['{} p={:.2g}'.format(test_name, pv)])
  annotator.annotate()
```

```{python}
annot = pd.read_csv('../data/batches12_chemo_regimen_annotation.tsv', sep='\t', index_col=0)
annot['Primary Study ID'] = annot.loc[:, 'Primary Study ID'].astype(str)
platinum_type_dict = annot.set_index('Primary Study ID').loc[:, 'platinum_type'].to_dict()
plt0 = pd.Series(platinum_type_dict)
plt0 = plt0[plt0 == 'Cisplatin']
plt_list = list(pd.Series(plt0.index) + ' Cystectomy') + list(pd.Series(plt0.index) + ' TUR')
```

```{python}
all_med = pd.read_csv('../data/all_median_distances_wo_offset.tsv', sep='\t', index_col=0)
all_med = all_med.loc[all_med.index.isin(plt_list)]
norm_log_dens = pd.read_csv('../data/combined_norm_log10_density.tsv', sep='\t', index_col=0)
dens_columns = ['B_cells', 'CD4_Tcells', 'Macrophages', 'Tregs', 'CD8_Tcells', 'PanCK+_cells', 'Negative_cells', 'pt_number', 'sample_type']
all_dens = norm_log_dens.loc[norm_log_dens.index.isin(plt_list), dens_columns]
```



```{python}
pdl1 = pd.read_csv('../data/Prepost NAC patients overview PD-L1.csv', sep=';', index_col=0)
pdl1_cys = pdl1.loc[~pdl1.index.isna(), ['Material.1', 'CPS (%).1', 'IC (%).1', 'TC (%).1']].dropna()
pdl1_tur = pdl1.loc[~pdl1.index.isna(), ['Material', 'CPS (%)', 'IC (%)', 'TC (%)']].dropna().replace('76,5', '76.5')
pdl1_tur.index = pdl1_tur.index.astype(int).astype(str) + ' TUR'
pdl1_cys.index = pdl1_cys.index.astype(int).astype(str) + ' Cystectomy'
pdl1_cys.columns = ['Material', 'CPS (%)', 'IC (%)', 'TC (%)']
pdl1_tur = np.log10(pdl1_tur.drop('Material', axis=1).astype(float)+1)
pdl1_cys = np.log10(pdl1_cys.drop('Material', axis=1).astype(float)+1)
#pdl1_tur = pdl1_tur.drop('Material', axis=1).astype(float)
#pdl1_cys = pdl1_cys.drop('Material', axis=1).astype(float)
pdl1_df = pd.concat([pdl1_tur.assign(sample_type = 'TUR'), pdl1_cys.assign(sample_type = 'Cystectomy')])
pdl1_df = pdl1_df.assign(pt_number = pdl1_df.index.str.split(' ').str[0]).rename(columns = {'CPS (%)': 'CPS', 'IC (%)': 'IC', 'TC (%)': 'TC'})
pdl1_df = pdl1_df.loc[pdl1_df.index.isin(plt_list)]
```

```{python}
ssgsea = pd.read_csv('../data/ssgsea_scores_fig4.tsv', sep='\t', index_col=0)
ssgsea = ssgsea.loc[ssgsea.index.isin(plt_list)]
ssgsea_h = ssgsea.copy()
```

```{python}
dist_list = ['CD8_Tcell_to_tumor_median', 'Macrophage_to_tumor_median','CD4_Tcell_to_tumor_median', 'Treg_to_tumor_median', 'Bcell_to_tumor_median']
dens_list = ['CD8_Tcells', 'Macrophages']
pdl1_list = ['IC']
sign_list = ['Fibroblast TGFb', 'EMT', 'TNFa-via-NFkB']
```

```{python}
sample_type1 = 'Cystectomy'
df_cys = pd.concat([ssgsea_h.loc[ssgsea_h[ssgsea_h.sample_type == sample_type1].index, ['EMT', 'TNFa-via-NFkB']],
ssgsea.loc[ssgsea[ssgsea.sample_type == sample_type1].index, ['Fibroblast TGFb']],
all_dens.loc[all_dens[all_dens.sample_type == sample_type1].index, dens_list],
np.log10(all_med.loc[all_med[all_med.sample_type == sample_type1].index, dist_list]),
pdl1_df.loc[pdl1_df[pdl1_df.sample_type == sample_type1].index, pdl1_list]], axis=1)
```

```{python}
sample_type1 = 'TUR'
df_tur = pd.concat([ssgsea_h.loc[ssgsea_h[ssgsea_h.sample_type == sample_type1].index, ['EMT', 'TNFa-via-NFkB']],
ssgsea.loc[ssgsea[ssgsea.sample_type == sample_type1].index, ['Fibroblast TGFb']],
all_dens.loc[all_dens[all_dens.sample_type == sample_type1].index, dens_list],
np.log10(all_med.loc[all_med[all_med.sample_type == sample_type1].index, dist_list]).drop('85 TUR'),
pdl1_df.loc[pdl1_df[pdl1_df.sample_type == sample_type1].index, pdl1_list]], axis=1)
```

```{python}
sign_list = sign_list + pdl1_list
```

```{python}
df_cysn = df_cys.copy()
df_turn = df_tur.copy()
df_cysn.index = df_cysn.index.str.split(' ').str[0]
df_turn.index = df_turn.index.str.split(' ').str[0]
common_index = df_cysn.index.intersection(df_turn.index)
df_delta = df_cysn.loc[common_index] - df_turn.loc[common_index, df_cysn.columns]
```

```{python}
def prep_annot(selected_r, selected_p):
  extreme_1 = 0.05
  extreme_2 = 0.01
  extreme_3 = 0.001
  annot = [[('' if abs(val) > extreme_1 else '\n*')
            + ('' if abs(val) > extreme_2 else '*')
            + ('' if abs(val) > extreme_3 else '*')
            for val in row] for row in selected_p.to_numpy()]
  annot = selected_r.applymap('{:.2f}'.format).to_numpy() + annot
  return annot
```

```{python}
def ht_pearson(df_cys, ax, mult_corr = True, cbar = True):
  selected_r = df_cys.corr(method = 'pearson').loc[dens_list+ dist_list, ['Fibroblast TGFb', 'EMT', 'TNFa-via-NFkB']]
  selected_p0 = df_cys.corr(method=lambda x, y: pearsonr(x, y)[1]).loc[dens_list+ dist_list, ['Fibroblast TGFb', 'EMT', 'TNFa-via-NFkB']]
  if mult_corr:
    selected_p = pd.DataFrame({k:multipletests(v, method = 'fdr_bh')[1] for k,v in selected_p0.items()}, index = selected_p0.index)
  else:
    selected_p = selected_p0.copy()
  _ = sns.heatmap(selected_r, cmap = 'coolwarm', annot = prep_annot(selected_r, selected_p), yticklabels = True, ax=ax, vmin=-1, vmax=1, fmt='', cbar = cbar)
  ax.set_xticklabels(ax.get_xticklabels(), rotation=90)
  
def ht_spearman(df_cys, ax, mult_corr = True, cbar = True):
  selected_r = df_cys.corr(method = 'spearman').loc[dens_list+ dist_list, sign_list]
  selected_p0 = df_cys.corr(method=lambda x, y: spearmanr(x, y)[1]).loc[dens_list+ dist_list, sign_list]
  if mult_corr:
    selected_p = pd.DataFrame({k:multipletests(v, method = 'fdr_bh')[1] for k,v in selected_p0.items()}, index = selected_p0.index)
  else:
    selected_p = selected_p0.copy()
  _ = sns.heatmap(selected_r, cmap = 'coolwarm', annot = prep_annot(selected_r, selected_p), yticklabels = True, ax=ax, vmin=-1, vmax=1, fmt='', cbar = cbar)
  ax.set_xticklabels(ax.get_xticklabels(), rotation=90)
  
def ht_kendall(df_cys, ax, mult_corr = True, cbar = True):
  selected_r = df_cys.corr(method = 'kendall').loc[dens_list+ dist_list, sign_list]
  selected_p0 = df_cys.corr(method=lambda x, y: kendalltau(x, y)[1]).loc[dens_list+ dist_list, sign_list]
  if mult_corr:
    selected_p = pd.DataFrame({k:multipletests(v, method = 'fdr_bh')[1] for k,v in selected_p0.items()}, index = selected_p0.index)
  else:
    selected_p = selected_p0.copy()
  _ = sns.heatmap(selected_r, cmap = 'coolwarm', annot = prep_annot(selected_r, selected_p), yticklabels = True, ax=ax, vmin=-1, vmax=1, fmt='', cbar = cbar)
  ax.set_xticklabels(ax.get_xticklabels(), rotation=90)
```

```{python}
def assign_label(x, ser):
  med = ser.dropna().median()
  if x <= med:
    return('low')
  elif x > med:
    return('high')
```

```{python}
df_cys_log = df_cys.assign(sig_level = df_cys.loc[:, 'Fibroblast TGFb'].apply(lambda x: assign_label(x, df_cys.loc[:, 'Fibroblast TGFb']))).assign(ic_level = df_cys.loc[:, 'IC'].apply(lambda x: assign_label(x, df_cys.loc[:, 'IC']))).assign(dist_level = df_cys.loc[:, 'CD8_Tcell_to_tumor_median'].apply(lambda x: assign_label(x, df_cys.loc[:, 'CD8_Tcell_to_tumor_median'])))
df_tur_log = df_tur.assign(ic_level = df_tur.loc[:, 'IC'].apply(lambda x: assign_label(x, df_tur.loc[:, 'IC']))).assign(dist_level = df_tur.loc[:, 'CD8_Tcell_to_tumor_median'].apply(lambda x: assign_label(x, df_tur.loc[:, 'CD8_Tcell_to_tumor_median'])))
df_delta_log = df_delta.assign(sig_level = df_delta.loc[:, 'TNFa-via-NFkB'].apply(lambda x: assign_label(x, df_delta.loc[:, 'TNFa-via-NFkB'])))
df_cys_lin = (10**df_cys).assign(sig_level = df_cys_log.loc[:, 'sig_level']).assign(ic_level = df_cys_log.loc[:, 'ic_level']).assign(dist_level = df_cys_log.loc[:, 'dist_level'])
df_tur_lin = (10**df_tur).assign(ic_level = df_tur_log.loc[:, 'ic_level']).assign(dist_level = df_tur_log.loc[:, 'dist_level'])
df_delta_lin = (10**df_delta).assign(sig_level = df_delta_log.loc[:, 'sig_level'])
```

```{python}
res_list = []
for u1 in dens_list+ dist_list + pdl1_list:
  for u2 in sign_list:
    res_loc = spearman_diff(df_tur, df_cys, u1, u2)
    res_list.append({'u1': u1, 'u2': u2, 'p_value_ind': res_loc[0],
    'r12': res_loc[1], 'r34': res_loc[2]})
res_long_spearman = pd.DataFrame(res_list)
```

```{python}
res_list = []
for u1 in dens_list+ dist_list + pdl1_list:
  for u2 in sign_list:
    res_loc = pearson_diff(df_tur, df_cys, u1, u2)
    res_list.append({'u1': u1, 'u2': u2, 'p_value_ind': res_loc[0],
    'r12': res_loc[1], 'r34': res_loc[2]})
res_long_pearson = pd.DataFrame(res_list)
```

```{python}
res_list = []
for u1 in dens_list+ dist_list + pdl1_list:
  for u2 in sign_list:
    res_loc = kendall_diff(df_tur, df_cys, u1, u2)
    res_list.append({'u1': u1, 'u2': u2, 'p_value_ind': res_loc[0],
    'r12': res_loc[1], 'r34': res_loc[2]})
res_long_kendall = pd.DataFrame(res_list)
```

```{python}
res_long_spearman = res_long_spearman[(res_long_spearman.u2 != 'EMT') & (res_long_spearman.u1 != 'IC')]
res_long_pearson = res_long_pearson[(res_long_pearson.u2 != 'EMT') & (res_long_pearson.u1 != 'IC')]
res_long_kendall = res_long_kendall[(res_long_kendall.u2 != 'EMT') & (res_long_kendall.u1 != 'IC')]
sign_list1 = ['Fibroblast TGFb', 'TNFa-via-NFkB', 'IC']
```

```{python}
res_long_spearman['p_value_ind'] = multipletests(res_long_spearman['p_value_ind'], method = 'fdr_bh')[1]
res_long_pearson['p_value_ind'] = multipletests(res_long_pearson['p_value_ind'], method = 'fdr_bh')[1]
res_long_kendall['p_value_ind'] = multipletests(res_long_kendall['p_value_ind'], method = 'fdr_bh')[1]
```

```{python}
def simple_scatter_spearman(df, x, y, ax):
    x1 = df.loc[:, x]
    y1 = df.loc[:, y]
    nas = np.logical_or(x1.isna(), y1.isna())
    x1 = x1[~nas]
    y1 = y1[~nas]
    df_delta = df.loc[x1.index]
    g = sns.regplot(x = x, y=y, data=df_delta, color=".3", line_kws=dict(color="r"), ax=ax, robust = True)
    ax.set_title('Spearman R = {:.2f}, p = {:.2g}'.format(*spearmanr(x1,y1)), fontsize=14)
    
def simple_scatter_both(df, x, y, ax):
    x1 = df.loc[:, x]
    y1 = df.loc[:, y]
    nas = np.logical_or(x1.isna(), y1.isna())
    x1 = x1[~nas]
    y1 = y1[~nas]
    df_delta = df.loc[x1.index]
    g = sns.regplot(x = x, y=y, data=df_delta, color=".3", line_kws=dict(color="r"), ax=ax, robust = True)
    ax.set_title('Spearman R = {:.2f}, p = {:.2g}\nPearson R = {:.2f}, p = {:.2g}'.format(*spearmanr(x1,y1),*pearsonr(x1,y1)), fontsize=14)
```

## Kendall
```{python}
tick_list = ['CD8 T cell percentage', 'Macrophage percentage',
       'CD8 T cell to\ncancer cell distance', 'Macrophage to\ncancer cell distance',
       'T helper to\ncancer cell distance', 'Treg to \ncancer cell distance',
       'B cell to\ncancer cell distance']
```


```{python}
df_lin = pd.concat([df_tur_lin.assign(sample_type = 'TUR'), df_cys_lin.assign(sample_type = 'Cystectomy')])
df_log = pd.concat([df_tur_log.assign(sample_type = 'TUR'), df_cys_log.assign(sample_type = 'Cystectomy')])
```


```{python, fig.width = 16, fig.height = 5}
plt.rcParams.update({'font.size': 12})
box_palette = {'high': 'bisque', 'low': 'powderblue'}
cmap_reversed = matplotlib.cm.get_cmap('RdYlBu_r')
plt.close()
fig, axs = plt.subplots(1,3, figsize = (16, 5))
af = axs.flat
ht_kendall(df_delta, af[0], mult_corr=True, cbar = False)
ht_kendall(df_cys, af[1], mult_corr=True, cbar = False)
ht_kendall(df_tur, af[2], mult_corr=True, cbar = True)
af[0].set_ylabel('delta')
#af[0].set_xlabel('delta')
af[1].set_yticklabels([])
af[1].set_ylabel('in cystectomy samples')
#af[1].set_xlabel('in cystectomy samples')
af[2].set_yticklabels([])
af[2].set_ylabel('in TUR-BT samples')
#af[2].set_xlabel('in TUR samples')
af[1].set_yticks([])
af[2].set_yticks([])

af[0].set_yticklabels(tick_list)
af[0].set_xticklabels(['Fibroblast TGFb', 'EMT', 'TNFa-via-NFkB', 'PD-L1 IC'])
af[1].set_xticklabels(['Fibroblast TGFb', 'EMT', 'TNFa-via-NFkB', 'PD-L1 IC'])
af[2].set_xticklabels(['Fibroblast TGFb', 'EMT', 'TNFa-via-NFkB', 'PD-L1 IC'])

df_delta_log2 = df_delta_log.copy()
df_delta_log2.loc[:, 'CD8_Tcells'] = df_delta_log2.loc[:, 'CD8_Tcells']/np.log10(2)
plt.subplots_adjust(hspace=0.35, wspace=0.3)
fig.set_tight_layout(True)
plt.show()
```
```{python, fig.width = 16, fig.height = 10}
plt.rcParams.update({'font.size': 12})
plt.close()
fig, axs = plt.subplots(2,2, figsize = (16, 10), width_ratios = [5, 10])
af = axs.flat
box_comp_ic('CD8_Tcells', af[0], df_delta_log2, '', 'Log2 FC in CD8 T cell percentage', swarm=False)
af[0].set_xticklabels(['change in\nTNFa-via-NFkB\nlower than median', 'change in\nTNFa-via-NFkB\nhigher than median'])

simple_scatter_spearman(df_cys, x = 'Fibroblast TGFb', y='CD8_Tcell_to_tumor_median', ax = af[2])
af[2].set_xlabel('Fibroblast TGFb in cystectomies')
af[2].set_ylabel('log10(CD8 T cell to 1-NN cancer cell\nmedian distance) in cystectomies')

#box_comp_ic('Fibroblast TGFb', af[5], df_cys_lin, '', 'TGFb signaling\nin fibroblasts', x = 'ic_level', swarm=False)
dyn_comp_lin('Fibroblast TGFb', af[1], df_lin, '', 'TGFb signaling\nin fibroblasts')
dyn_comp_lin('CD8_Tcell_to_tumor_median', af[3], df_lin, '', 'CD8 T cell to 1-NN cancer cell\nmedian distance, um', log_scale=True, log_data = df_log)

af[3].set_yticks([10, 50,100], ['10','50', '100'])

handles, labels = af[1].get_legend_handles_labels()
af[1].legend(handles[0:2], ['PD-L1 IC lower\nthan median', 'PD-L1 IC higher\nthan median'], loc='upper center')
af[1].set_xticklabels(['TUR-BT', 'Cystectomy'])
handles, labels = af[3].get_legend_handles_labels()
af[3].legend(handles[0:2], ['PD-L1 IC lower\nthan median', 'PD-L1 IC higher\nthan median'], loc='upper center')
af[3].set_xticklabels(['TUR-BT', 'Cystectomy'])

plt.subplots_adjust(hspace=0.35, wspace=0.2)
#fig.set_tight_layout(True)
plt.show()
```

## Pearson

```{python, fig.width = 16, fig.height = 5}
plt.rcParams.update({'font.size': 12})
box_palette = {'high': 'bisque', 'low': 'powderblue'}
cmap_reversed = matplotlib.cm.get_cmap('RdYlBu_r')
plt.close()
fig, axs = plt.subplots(1,3, figsize = (16, 5))
af = axs.flat
ht_pearson(df_delta, af[0], mult_corr=False, cbar = False)
ht_pearson(df_cys, af[1], mult_corr=True, cbar = False)
ht_pearson(df_tur, af[2], mult_corr=True, cbar = True)
af[0].set_ylabel('delta')
af[1].set_yticklabels([])
af[1].set_ylabel('in cystectomy samples')
#af[2].set_yticklabels([])
af[2].set_ylabel('in TUR-BT samples')

af[0].set_yticklabels(tick_list)
af[1].set_yticks([])
af[2].set_yticklabels([])
af[0].set_xticklabels(['Fibroblast TGFb', 'EMT', 'TNFa-via-NFkB'])
af[1].set_xticklabels(['Fibroblast TGFb', 'EMT', 'TNFa-via-NFkB'])
af[2].set_xticklabels(['Fibroblast TGFb', 'EMT', 'TNFa-via-NFkB'])

plt.subplots_adjust(hspace=0.35, wspace=0.35)
fig.set_tight_layout(True)
plt.show()
```

```{python, fig.width = 8, fig.height = 5}
plt.rcParams.update({'font.size': 12})
box_palette = {'high': 'bisque', 'low': 'powderblue'}
cmap_reversed = matplotlib.cm.get_cmap('RdYlBu_r')
plt.close()
fig, ax = plt.subplots(1,1, figsize = (8, 5))
df = pd.pivot_table(res_long_kendall, values = 'p_value_ind', index = 'u1', columns = 'u2').loc[dens_list+ dist_list, sign_list1]
_ = sns.heatmap(df, cmap = cmap_reversed, annot = df, yticklabels = True, ax=ax, vmin=0, vmax=0.1, alpha=0.6)
ax.set_xlabel('')
ax.set_ylabel('')
#ax.set_yticks(tick_list)
ax.set_yticklabels(tick_list)
ax.set_xticklabels(['Fibroblast TGFb', 'TNFa-via-NFkB', 'PD-L1 IC'], rotation=90)

plt.subplots_adjust(hspace=0.35, wspace=0.35)
fig.set_tight_layout(True)
plt.show()
```

```{python}
def prepare_volcano(df_tocomp, dens=False, dist=False):
    if dens:
      tm = 10**df_tocomp.drop('emt_group', axis=1)
      means = pd.concat([tm, df_tocomp.loc[:, 'emt_group']], axis=1).groupby('emt_group').mean()
    elif dist:
      tm = 2**df_tocomp.drop('emt_group', axis=1)
      means = pd.concat([tm, df_tocomp.loc[:, 'emt_group']], axis=1).groupby('emt_group').mean()
    else:
      means = df_tocomp.groupby('delta_sig_level').mean()
    logfc = np.log2(means.loc['high'].divide(means.loc['low']))
    logfc.name = 'log FC'
    a_list = []
    for ph in means.columns:
        u = df_tocomp[df_tocomp.delta_sig_level == 'high'].loc[:, ph]
        v = df_tocomp[df_tocomp.delta_sig_level == 'low'].loc[:, ph]
        a_list.append(mannwhitneyu(u, v, nan_policy = 'omit').pvalue)
    pdf = pd.DataFrame({'pvalue': a_list, 'iind': list(means.columns)})
    dendf = pd.concat([logfc, pdf.set_index('iind')], axis=1).dropna()
    return dendf.assign(pv_cor = multipletests(dendf.pvalue, method = 'fdr_bh')[1])
```
```{python}
df_cys_log2 = df_cys_log.set_index(df_cys_log.index.str.split(' ').str[0])
common_index = df_cys_log2.index.intersection(df_delta_log.index)
df_cys_log2 = df_cys_log2.loc[common_index].assign(delta_sig_level = df_delta_log.sig_level.loc[common_index])
volc_cys = prepare_volcano(df_cys_log2)

df_tur_log2 = df_tur_log.set_index(df_tur_log.index.str.split(' ').str[0])
common_index = df_tur_log2.index.intersection(df_delta_log.index)
df_tur_log2 = df_tur_log2.loc[common_index].assign(delta_sig_level = df_delta_log.sig_level.loc[common_index])
volc_tur = prepare_volcano(df_tur_log2)
```
```{python}
volc_delta = prepare_volcano(df_delta_log.rename(columns = {'sig_level': 'delta_sig_level'}))
```

```{python}
plt.rcParams.update({'font.size': 14})
def simple_scatter(df, x, y, ax):
    x1 = df.loc[:, x]
    y1 = df.loc[:, y]
    nas = np.logical_or(x1.isna(), y1.isna())
    x1 = x1[~nas]
    y1 = y1[~nas]
    df_delta = df.loc[x1.index]
    g = sns.regplot(x = x, y=y, data=df_delta, color=".3", line_kws=dict(color="r"), ax=ax)
    ax.set_title('Kendall tau = {:.2f}, p = {:.2g}'.format(*kendalltau(x1,y1)), fontsize=14)
```


```{python, fig.width = 17, fig.height = 11}
plt.close()
fig, axs = plt.subplots(2,3, figsize = (17, 11))
af = axs.flat
simple_scatter(df_delta, x = 'TNFa-via-NFkB', y='CD8_Tcells', ax = af[0])
af[0].set_xlabel('Δ TNFa-via-NFkB upon treatment')
af[0].set_ylabel('Δ log10(CD8 T cell percentage)\nupon treatment')

simple_scatter(df_cys, x = 'TNFa-via-NFkB', y='CD8_Tcells', ax = af[1])
af[1].set_xlabel('TNFa-via-NFkB in cystectomies')
af[1].set_ylabel('log10(CD8 T cell percentage)\nin cystectomies')

simple_scatter(df_tur, x = 'TNFa-via-NFkB', y='CD8_Tcells', ax = af[2])
af[2].set_xlabel('TNFa-via-NFkB in TUR')
af[2].set_ylabel('log10(CD8 T cell percentage)\nin TUR-BT')

simple_scatter(df_cys, x = 'IC', y='Fibroblast TGFb', ax = af[3])
af[3].set_xlabel('log10(IC + 1) in cystectomies')
af[3].set_ylabel('Fibroblast TGFb in cystectomies')

simple_scatter(df_cys, x = 'IC', y='CD8_Tcell_to_tumor_median', ax = af[4])
af[4].set_xlabel('log10(IC + 1) in cystectomies')
af[4].set_ylabel('log10(CD8 T cell to 1-NN cancer cell\nmedian distance) in cystectomies')

simple_scatter(df_tur, x = 'IC', y='CD8_Tcell_to_tumor_median', ax = af[5])
af[5].set_xlabel('log10(IC + 1) in TUR-BT')
af[5].set_ylabel('log10(CD8 T cell to 1-NN cancer cell\nmedian distance) in TUR-BT')

plt.subplots_adjust(hspace=0.4, wspace=0.45)
plt.show()
```

